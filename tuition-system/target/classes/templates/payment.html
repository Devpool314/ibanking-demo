<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thanh toán học phí</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 30px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        label { display: block; font-weight: bold; margin-top: 12px; }
        input { width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; }
        button { margin-top: 15px; padding: 10px 15px; background: #007bff; border: none; color: white; border-radius: 6px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .message { margin-top: 8px; font-size: 14px; }
    </style>
</head>
<body>
<div class="container">
    <h2>Thanh toán học phí</h2>

    <form th:action="@{/payment/request}" method="post" th:object="${payment}">
        <label>MSSV:</label>
        <input type="text" id="mssv" th:field="*{mssv}" placeholder="Nhập MSSV" required>

        <label>Họ tên:</label>
        <input type="text" id="fullname" readonly>

        <label>Số tiền cần nộp (VNĐ):</label>
        <input type="number" id="amount" th:field="*{amount}" step="1000" readonly>

        <label>Số dư khả dụng (VNĐ):</label>
        <input type="text" id="availableBalance" th:field="*{availableBalance}" readonly>

        <label>Người nộp tiền:</label>

        <input type="text" th:field="*{payerUsername}" th:value="${currentUser}" readonly>

        <div id="message" class="message"></div>

        <label>
          <input type="checkbox" id="termsCheckbox" th:field="*{termsAccepted}" required>
          Tôi đồng ý với <a href="#" onclick="openTerms(); return false;">các điều khoản và điều kiện</a>.
        </label>

        <button type="submit" id="confirmBtn" disabled>Xác nhận thanh toán</button>
    </form>
</div>

<script>
/* JS của bạn giữ nguyên */
document.addEventListener("DOMContentLoaded", () => {
    const mssvInput = document.getElementById("mssv");
    const fullname = document.getElementById("fullname");
    const amount = document.getElementById("amount");
    const availableBalance = document.getElementById("availableBalance");
    const message = document.getElementById("message");
    const confirmBtn = document.getElementById("confirmBtn");
    confirmBtn.disabled = true;

    let timeout = null;

    function parseNumberSafe(val) {
        if (val === null || val === undefined || val === "") return 0;
        const s = String(val).replace(/[, ]+/g, '');
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function validateAndUpdate() {
        const bal = parseNumberSafe(availableBalance.value);
        const tuition = parseNumberSafe(amount.value);
        if (tuition <= 0) { confirmBtn.disabled = true; message.textContent = ""; return; }
        if (message.textContent && message.textContent.includes('đã nộp')) { confirmBtn.disabled = true; return; }
        if (bal < tuition) { message.textContent = "❌ Số dư khả dụng không đủ để thanh toán (cần: " + tuition + " VND)."; message.style.color = "red"; confirmBtn.disabled = true; }
        else { message.textContent = ""; confirmBtn.disabled = false; }
    }

    mssvInput.addEventListener("input", function() {
        clearTimeout(timeout);
        const mssv = this.value.trim();
        if (mssv.length >= 3) {
            timeout = setTimeout(() => {
                fetch(`/api/payments/check/${encodeURIComponent(mssv)}`)
                    .then(res => { if (!res.ok) throw new Error('Network response was not ok'); return res.json(); })
                    .then(data => {
                        if (data.found) {
                            fullname.value = data.fullname || "";
                            amount.value = data.amount != null ? data.amount : "";
                            if (data.paid) { message.textContent = "⚠️ Sinh viên này đã nộp học phí!"; message.style.color = "orange"; confirmBtn.disabled = true; }
                            else { message.textContent = ""; validateAndUpdate(); }
                        } else {
                            fullname.value = ""; amount.value = "";
                            message.textContent = "❌ Không tìm thấy MSSV!"; message.style.color = "red"; confirmBtn.disabled = true;
                        }
                    })
                    .catch(err => { console.error(err); message.textContent = "Lỗi khi kiểm tra MSSV!"; message.style.color = "red"; confirmBtn.disabled = true; });
            }, 500);
        } else { fullname.value = ""; amount.value = ""; message.textContent = ""; confirmBtn.disabled = true; }
    });

    validateAndUpdate();
});
</script>
</body>
</html>
